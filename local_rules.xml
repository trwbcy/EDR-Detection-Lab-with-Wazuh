<!-- Local rules -->

<!-- Modify it at your will. -->
<!-- Copyright (C) 2015, Wazuh Inc. -->

<!-- Example -->
<group name="local,syslog,sshd,">

  <!--
  Dec 10 01:02:02 host sshd[1234]: Failed none for root from 1.1.1.1 port 1066 ssh2
  -->
  <rule id="100001" level="5">
    <if_sid>5716</if_sid>
    <srcip>1.1.1.1</srcip>
    <description>sshd: authentication failed from IP 1.1.1.1.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>

</group>

<group name="custom,windows,attack,">

  <!-- TEST: PowerShell encoded detection (multiple path variants) -->
  <rule id="900101" level="10">
    <field name="data.win.eventdata.processName" type="pcre2">(?i)powershell(?:\.exe)?</field>
    <field name="data.win.eventdata.commandLine" type="pcre2">(?i)(-enc|-encodedcommand|-e |-nop|-noni)</field>
    <field name="data.win.eventdata.CommandLine" type="pcre2">(?i)(-enc|-encodedcommand|-e |-nop|-noni)</field>
    <field name="winlog.event_data.CommandLine" type="pcre2">(?i)(-enc|-encodedcommand|-e |-nop|-noni)</field>
    <description>PowerShell encoded/obfuscated command detected (multi-path)</description>
    <group>execution,powershell,encoded</group>
  </rule>

  <!-- Process create with long command line (generic catch) -->
  <rule id="900102" level="8">
    <field name="data.win.eventdata.processName" type="pcre2">(?i)(powershell|cmd|cscript|wscript|rundll32)</field>
    <field name="data.win.eventdata.commandLine" type="pcre2">(?i).{40,}</field>
    <field name="data.win.eventdata.CommandLine" type="pcre2">(?i).{40,}</field>
    <description>ProcessCreate with long commandline (possible encoded payload)</description>
    <group>execution,processcreate,commandline</group>
  </rule>

  <!-- Suspicious parent-child (WerFault or Service spawning powershell) -->
  <rule id="900103" level="12">
    <field name="data.win.eventdata.processName" type="pcre2">(?i)powershell(?:\.exe)?</field>
    <field name="data.win.eventdata.processName" type="pcre2">(?i)powershell</field>
    <field name="data.win.eventdata.parentImage" type="pcre2">(?i)WerFault\.exe|services\.exe|svchost\.exe|explorer\.exe|w3wp\.exe</field>
    <description>PowerShell spawned by suspicious parent</description>
    <group>execution,parent-suspicious</group>
  </rule>

  <!-- Network connect to attacker IP/ports (Sysmon EventID 3 variants) -->
  <rule id="900104" level="9">
    <field name="data.win.eventdata.destinationIp" type="pcre2">(?i)192\.168\.71\.100</field>
    <field name="data.win.eventdata.destinationPort" type="pcre2">^(1337|4444|5555|8888)$</field>
    <field name="winlog.event_data.DestinationIp" type="pcre2">(?i)192\.168\.71\.100</field>
    <field name="winlog.event_data.DestinationPort" type="pcre2">^(1337|4444|5555|8888)$</field>
    <description>Network connect to known attacker IP / C2 ports</description>
    <group>network,c2</group>
  </rule>

</group>